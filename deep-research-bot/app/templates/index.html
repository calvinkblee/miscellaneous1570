{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - Deep Research Bot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-figure text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <div class="stat-title">ì´ ì½˜í…ì¸ </div>
            <div class="stat-value text-primary" id="stat-total">-</div>
            <div class="stat-desc">ìˆ˜ì§‘ëœ ì „ì²´ ì½˜í…ì¸ </div>
        </div>
        
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-figure text-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="stat-title">ë¶„ì„ ì™„ë£Œ</div>
            <div class="stat-value text-success" id="stat-analyzed">-</div>
            <div class="stat-desc">AI ë¶„ì„ ì™„ë£Œëœ ì½˜í…ì¸ </div>
        </div>
        
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-figure text-warning">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
            </div>
            <div class="stat-title">ì¶”ì²œ ì½˜í…ì¸ </div>
            <div class="stat-value text-warning" id="stat-high">-</div>
            <div class="stat-desc">ê³µìœ  ì ìˆ˜ 80ì  ì´ìƒ</div>
        </div>
        
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-figure text-info">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
            </div>
            <div class="stat-title">í™œì„± í‚¤ì›Œë“œ</div>
            <div class="stat-value text-info" id="stat-keywords">-</div>
            <div class="stat-desc">ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ í‚¤ì›Œë“œ</div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Source Distribution -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">ì†ŒìŠ¤ë³„ ë¶„í¬</h2>
                <div id="source-chart" class="flex flex-wrap gap-4 pt-4">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
        
        <!-- Recent Research Logs -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">ìµœê·¼ ë¦¬ì„œì¹˜ ê¸°ë¡</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                                <th>ìˆ˜ì§‘</th>
                                <th>ë¶„ì„</th>
                            </tr>
                        </thead>
                        <tbody id="research-logs">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Contents -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center">
                <h2 class="card-title">ğŸ”¥ ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì½˜í…ì¸ </h2>
                <a href="/contents?min_score=80" class="btn btn-sm btn-ghost">ì „ì²´ ë³´ê¸° â†’</a>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4" id="top-contents">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            document.getElementById('stat-total').textContent = data.total_contents.toLocaleString();
            document.getElementById('stat-analyzed').textContent = data.analyzed_contents.toLocaleString();
            document.getElementById('stat-high').textContent = data.high_score_contents.toLocaleString();
            document.getElementById('stat-keywords').textContent = data.active_keywords.toLocaleString();
            
            // Source chart
            const sourceChart = document.getElementById('source-chart');
            sourceChart.innerHTML = '';
            
            const sourceLabels = {
                youtube: { icon: 'â–¶ï¸', label: 'YouTube', color: 'bg-red-500' },
                news: { icon: 'ğŸ“°', label: 'ë‰´ìŠ¤', color: 'bg-blue-500' },
                blog: { icon: 'ğŸ“', label: 'ë¸”ë¡œê·¸', color: 'bg-green-500' },
                paper: { icon: 'ğŸ“„', label: 'ë…¼ë¬¸', color: 'bg-purple-500' },
                podcast: { icon: 'ğŸ™ï¸', label: 'íŒŸìºìŠ¤íŠ¸', color: 'bg-orange-500' }
            };
            
            for (const [source, count] of Object.entries(data.source_stats)) {
                const info = sourceLabels[source] || { icon: 'ğŸ“', label: source, color: 'bg-gray-500' };
                sourceChart.innerHTML += `
                    <div class="flex items-center gap-2 p-3 rounded-lg bg-base-200">
                        <span class="text-2xl">${info.icon}</span>
                        <div>
                            <div class="font-semibold">${info.label}</div>
                            <div class="text-2xl font-bold">${count}</div>
                        </div>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Stats loading error:', error);
        }
    }
    
    async function loadResearchLogs() {
        try {
            const response = await fetch('/api/research/logs?limit=5');
            const logs = await response.json();
            
            const tbody = document.getElementById('research-logs');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">ë¦¬ì„œì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            for (const log of logs) {
                const statusBadge = log.status === 'completed' 
                    ? '<span class="badge badge-success badge-sm">ì™„ë£Œ</span>'
                    : log.status === 'running'
                    ? '<span class="badge badge-info badge-sm">ì§„í–‰ì¤‘</span>'
                    : '<span class="badge badge-error badge-sm">ì‹¤íŒ¨</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td class="text-sm">${formatDate(log.started_at)}</td>
                        <td>${statusBadge}</td>
                        <td>${log.total_found}</td>
                        <td>${log.total_analyzed}</td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Logs loading error:', error);
        }
    }
    
    async function loadTopContents() {
        try {
            const response = await fetch('/api/contents?min_score=70&limit=6&sort_by=share_score');
            const contents = await response.json();
            
            const container = document.getElementById('top-contents');
            container.innerHTML = '';
            
            if (contents.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">ì•„ì§ ë¶„ì„ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. ë¦¬ì„œì¹˜ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            for (const content of contents) {
                const scoreClass = getScoreClass(content.ai_share_score);
                const sourceIcon = getSourceIcon(content.source_type);
                
                container.innerHTML += `
                    <a href="/content/${content.id}" class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body p-4">
                            <div class="flex items-start justify-between gap-2">
                                <span class="text-xl">${sourceIcon}</span>
                                <span class="badge ${scoreClass}">${Math.round(content.ai_share_score)}ì </span>
                            </div>
                            <h3 class="font-semibold text-sm line-clamp-2">${content.title}</h3>
                            <p class="text-xs text-gray-500 line-clamp-2">${content.ai_summary || content.description || ''}</p>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-gray-400">${content.source_name}</span>
                                <span class="text-xs text-gray-400">${content.keyword_name}</span>
                            </div>
                        </div>
                    </a>
                `;
            }
        } catch (error) {
            console.error('Contents loading error:', error);
        }
    }
    
    function refreshData() {
        loadStats();
        loadResearchLogs();
        loadTopContents();
    }
    
    // Initial load
    document.addEventListener('DOMContentLoaded', refreshData);
</script>
{% endblock %}

