{% extends "base.html" %}

{% block title %}ì½˜í…ì¸  - Deep Research Bot{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header & Filters -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold">ìˆ˜ì§‘ëœ ì½˜í…ì¸ </h1>
            <p class="text-gray-500">AIê°€ ë¶„ì„í•œ ì½˜í…ì¸ ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        
        <!-- Filters -->
        <div class="flex flex-wrap gap-2">
            <select id="filter-source" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="">ëª¨ë“  ì†ŒìŠ¤</option>
                <option value="youtube">YouTube</option>
                <option value="news">ë‰´ìŠ¤</option>
                <option value="blog">ë¸”ë¡œê·¸</option>
                <option value="paper">ë…¼ë¬¸</option>
                <option value="podcast">íŒŸìºìŠ¤íŠ¸</option>
            </select>
            
            <select id="filter-language" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="">ëª¨ë“  ì–¸ì–´</option>
                <option value="ko">í•œêµ­ì–´</option>
                <option value="en">English</option>
            </select>
            
            <select id="filter-score" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="">ëª¨ë“  ì ìˆ˜</option>
                <option value="80">80ì  ì´ìƒ</option>
                <option value="60">60ì  ì´ìƒ</option>
                <option value="40">40ì  ì´ìƒ</option>
            </select>
            
            <select id="filter-keyword" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="">ëª¨ë“  í‚¤ì›Œë“œ</option>
            </select>
            
            <select id="sort-by" class="select select-bordered select-sm" onchange="applyFilters()">
                <option value="share_score">ì ìˆ˜ìˆœ</option>
                <option value="published_at">ìµœì‹ ìˆœ</option>
                <option value="created_at">ìˆ˜ì§‘ìˆœ</option>
            </select>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="flex gap-2">
        <button class="btn btn-sm" onclick="filterStarred()">â­ ì¦ê²¨ì°¾ê¸°</button>
        <button class="btn btn-sm" onclick="filterHighScore()">ğŸ”¥ ì¶”ì²œ (80+)</button>
        <button class="btn btn-sm" onclick="clearFilters()">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>
    
    <!-- Contents List -->
    <div class="space-y-4" id="contents-list">
        <!-- Dynamic content -->
    </div>
    
    <!-- Load More -->
    <div class="text-center" id="load-more-container">
        <button class="btn btn-wide" id="load-more-btn" onclick="loadMore()">ë” ë³´ê¸°</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentOffset = 0;
    const limit = 20;
    let isLoading = false;
    
    async function loadKeywordOptions() {
        try {
            const response = await fetch('/api/keywords');
            const keywords = await response.json();
            
            const select = document.getElementById('filter-keyword');
            for (const kw of keywords) {
                const option = document.createElement('option');
                option.value = kw.id;
                option.textContent = kw.name;
                select.appendChild(option);
            }
        } catch (error) {
            console.error('Keywords loading error:', error);
        }
    }
    
    function buildQueryString() {
        const params = new URLSearchParams();
        
        const source = document.getElementById('filter-source').value;
        const language = document.getElementById('filter-language').value;
        const score = document.getElementById('filter-score').value;
        const keyword = document.getElementById('filter-keyword').value;
        const sortBy = document.getElementById('sort-by').value;
        
        if (source) params.append('source_type', source);
        if (language) params.append('language', language);
        if (score) params.append('min_score', score);
        if (keyword) params.append('keyword_id', keyword);
        params.append('sort_by', sortBy);
        params.append('limit', limit);
        params.append('offset', currentOffset);
        
        // Check URL params for starred filter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('starred') === 'true') {
            params.append('is_starred', 'true');
        }
        
        return params.toString();
    }
    
    async function loadContents(append = false) {
        if (isLoading) return;
        isLoading = true;
        
        const container = document.getElementById('contents-list');
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        if (!append) {
            container.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            currentOffset = 0;
        } else {
            loadMoreBtn.classList.add('loading');
        }
        
        try {
            const query = buildQueryString();
            const response = await fetch(`/api/contents?${query}`);
            const contents = await response.json();
            
            if (!append) {
                container.innerHTML = '';
            }
            
            if (contents.length === 0 && currentOffset === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-xl mb-2">ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p>í•„í„°ë¥¼ ì¡°ì •í•˜ê±°ë‚˜ ë¦¬ì„œì¹˜ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”</p>
                    </div>
                `;
                document.getElementById('load-more-container').style.display = 'none';
                return;
            }
            
            for (const content of contents) {
                container.innerHTML += createContentCard(content);
            }
            
            // Show/hide load more
            if (contents.length < limit) {
                document.getElementById('load-more-container').style.display = 'none';
            } else {
                document.getElementById('load-more-container').style.display = 'block';
            }
            
            currentOffset += contents.length;
            
        } catch (error) {
            console.error('Contents loading error:', error);
            if (!append) {
                container.innerHTML = '<div class="text-center text-error py-12">ì½˜í…ì¸  ë¡œë”© ì‹¤íŒ¨</div>';
            }
        } finally {
            isLoading = false;
            loadMoreBtn.classList.remove('loading');
        }
    }
    
    function createContentCard(content) {
        const scoreClass = getScoreClass(content.ai_share_score);
        const sourceIcon = getSourceIcon(content.source_type);
        const starClass = content.is_starred ? 'btn-warning' : 'btn-ghost';
        const languageFlag = content.language === 'ko' ? 'ğŸ‡°ğŸ‡·' : 'ğŸ‡ºğŸ‡¸';
        
        // Insights list
        let insightsHtml = '';
        if (content.ai_insights && content.ai_insights.length > 0) {
            insightsHtml = `
                <div class="mt-3">
                    <p class="text-xs font-semibold text-gray-500 mb-1">ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</p>
                    <ul class="text-sm space-y-1">
                        ${content.ai_insights.slice(0, 3).map(i => `<li class="text-gray-600">â€¢ ${i}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        return `
            <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow fade-in">
                <div class="card-body">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <!-- Thumbnail -->
                        ${content.thumbnail_url ? `
                            <div class="lg:w-48 flex-shrink-0">
                                <img src="${content.thumbnail_url}" alt="" class="w-full h-32 object-cover rounded-lg">
                            </div>
                        ` : ''}
                        
                        <!-- Content -->
                        <div class="flex-1">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">${sourceIcon}</span>
                                    <span class="badge ${scoreClass}">${Math.round(content.ai_share_score)}ì </span>
                                    <span class="text-sm">${languageFlag}</span>
                                    <span class="badge badge-outline badge-sm">${content.keyword_name}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button class="btn btn-xs ${starClass}" onclick="toggleStar(${content.id}, this)">
                                        ${content.is_starred ? 'â­' : 'â˜†'}
                                    </button>
                                </div>
                            </div>
                            
                            <a href="/content/${content.id}" class="hover:underline">
                                <h3 class="font-bold text-lg mt-2 line-clamp-2">${content.title}</h3>
                            </a>
                            
                            <p class="text-sm text-gray-500 mt-1">${content.source_name}</p>
                            
                            ${content.ai_summary ? `
                                <p class="text-sm mt-2 text-gray-700 line-clamp-2">${content.ai_summary}</p>
                            ` : ''}
                            
                            ${insightsHtml}
                            
                            <div class="flex items-center justify-between mt-4">
                                <div class="flex items-center gap-2 text-xs text-gray-400">
                                    <span>${formatDate(content.published_at)}</span>
                                </div>
                                <div class="flex gap-2">
                                    <a href="${content.url}" target="_blank" class="btn btn-sm btn-outline">
                                        ì›ë¬¸ ë³´ê¸° â†—
                                    </a>
                                    <a href="/content/${content.id}" class="btn btn-sm btn-primary">
                                        ìƒì„¸ ë³´ê¸°
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    async function toggleStar(contentId, btn) {
        try {
            const response = await fetch(`/api/contents/${contentId}/star`, { method: 'POST' });
            const data = await response.json();
            
            if (data.is_starred) {
                btn.classList.remove('btn-ghost');
                btn.classList.add('btn-warning');
                btn.textContent = 'â­';
            } else {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-ghost');
                btn.textContent = 'â˜†';
            }
        } catch (error) {
            showToast('ì¦ê²¨ì°¾ê¸° ë³€ê²½ ì‹¤íŒ¨', 'error');
        }
    }
    
    function applyFilters() {
        loadContents(false);
    }
    
    function loadMore() {
        loadContents(true);
    }
    
    function filterStarred() {
        window.history.pushState({}, '', '/contents?starred=true');
        loadContents(false);
    }
    
    function filterHighScore() {
        document.getElementById('filter-score').value = '80';
        applyFilters();
    }
    
    function clearFilters() {
        document.getElementById('filter-source').value = '';
        document.getElementById('filter-language').value = '';
        document.getElementById('filter-score').value = '';
        document.getElementById('filter-keyword').value = '';
        document.getElementById('sort-by').value = 'share_score';
        window.history.pushState({}, '', '/contents');
        applyFilters();
    }
    
    function refreshData() {
        loadContents(false);
    }
    
    // Check URL params on load
    document.addEventListener('DOMContentLoaded', () => {
        loadKeywordOptions();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('min_score')) {
            document.getElementById('filter-score').value = urlParams.get('min_score');
        }
        
        loadContents(false);
    });
</script>
{% endblock %}

